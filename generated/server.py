"""UniFi Network Controller MCP Server (auto-generated).

Generated from controller version 10.0.162.
Total tools: ~137

DO NOT EDIT THIS FILE. All changes must be made in the generator.
"""

from __future__ import annotations

import json
import os
from typing import Any

import httpx
from fastmcp import FastMCP

mcp = FastMCP("UniFi Network Controller")

# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------

UNIFI_HOST = os.environ.get("UNIFI_HOST", "localhost")
UNIFI_PORT = int(os.environ.get("UNIFI_PORT", "8443"))
UNIFI_USERNAME = os.environ.get("UNIFI_USERNAME", "admin")
UNIFI_PASSWORD = os.environ.get("UNIFI_PASSWORD", "")
UNIFI_SITE = os.environ.get("UNIFI_SITE", "default")
UNIFI_VERIFY_SSL = os.environ.get("UNIFI_VERIFY_SSL", "false").lower() == "true"


# ---------------------------------------------------------------------------
# HTTP Client
# ---------------------------------------------------------------------------


class UniFiClient:
    """Handles authentication, session cookies, and CSRF tokens."""

    def __init__(self) -> None:
        self._client = httpx.AsyncClient(
            base_url=f"https://{UNIFI_HOST}:{UNIFI_PORT}",
            verify=UNIFI_VERIFY_SSL,
            timeout=30.0,
        )
        self._csrf_token: str | None = None
        self._logged_in = False

    async def login(self) -> None:
        resp = await self._client.post(
            "/api/login",
            json={"username": UNIFI_USERNAME, "password": UNIFI_PASSWORD},
        )
        resp.raise_for_status()
        # Extract CSRF token from cookies or response
        self._csrf_token = resp.cookies.get("csrf_token") or resp.headers.get("x-csrf-token")
        self._logged_in = True

    async def logout(self) -> None:
        if self._logged_in:
            try:
                await self._client.post("/api/logout")
            except Exception:
                pass
            self._logged_in = False

    async def _ensure_logged_in(self) -> None:
        if not self._logged_in:
            await self.login()

    async def request(
        self,
        method: str,
        path: str,
        json_data: dict | None = None,
        site: str | None = None,
    ) -> dict | list:
        """Make an authenticated API request. Auto-relogins on 401."""
        await self._ensure_logged_in()

        # Replace {site} placeholder in path
        effective_site = site or UNIFI_SITE
        full_path = path.replace("{site}", effective_site)

        # Ensure path starts with /
        if not full_path.startswith("/"):
            full_path = f"/api/s/{effective_site}/{full_path}"

        headers = {}
        if self._csrf_token:
            headers["x-csrf-token"] = self._csrf_token

        try:
            resp = await self._client.request(
                method, full_path, json=json_data, headers=headers,
            )
        except httpx.ConnectError:
            raise RuntimeError(
                f"Connection failed: cannot reach UniFi controller at "
                f"{UNIFI_HOST}:{UNIFI_PORT}. Check UNIFI_HOST and UNIFI_PORT."
            )
        except httpx.TimeoutException:
            raise RuntimeError(
                f"Request timed out: {method} {full_path}. "
                f"The controller at {UNIFI_HOST}:{UNIFI_PORT} may be overloaded or unreachable."
            )

        # Auto-relogin on 401
        if resp.status_code == 401:
            await self.login()
            if self._csrf_token:
                headers["x-csrf-token"] = self._csrf_token
            resp = await self._client.request(
                method, full_path, json=json_data, headers=headers,
            )

        if resp.status_code == 403:
            raise RuntimeError(
                f"Authentication failed (403 Forbidden): {method} {full_path}. "
                f"Check UNIFI_USERNAME and UNIFI_PASSWORD."
            )

        resp.raise_for_status()
        data = resp.json()

        # v1 API envelope
        if isinstance(data, dict) and "meta" in data:
            if data["meta"].get("rc") != "ok":
                msg = data["meta"].get("msg", "Unknown error")
                raise RuntimeError(f"UniFi API error on {method} {full_path}: {msg}")
            return data.get("data", [])

        return data

    async def close(self) -> None:
        await self.logout()
        await self._client.aclose()


# Singleton client
_client = UniFiClient()


async def _get_client() -> UniFiClient:
    return _client


# ---------------------------------------------------------------------------
# Helper: format response
# ---------------------------------------------------------------------------

def _format_response(data: Any, summary: str | None = None) -> str:
    """Format API response data for tool output."""
    if summary:
        return f"{summary}\n\n{json.dumps(data, indent=2, default=str)}"
    return json.dumps(data, indent=2, default=str)


# ===========================================================================
# REST Endpoint Tools
# ===========================================================================

# --- Account CRUD ---

@mcp.tool()
async def unifi_list_accounts(site: str = "") -> str:
    """List all accounts.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/account", site=site or None)
    return _format_response(data, f"Found {len(data)} accounts")


@mcp.tool()
async def unifi_get_account(id: str, site: str = "") -> str:
    """Get a single account by ID.

    Args:
        id: The _id of the account.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/account/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_account(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new account.

    Args:
        data: Account configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_account", "data": data},
            "DRY RUN (POST rest/account): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/account", json_data=data, site=site or None)
    return _format_response(result, "Created account")


@mcp.tool()
async def unifi_update_account(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing account.

    Args:
        id: The _id of the account to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_account", "id": id, "data": data},
            "DRY RUN (PUT rest/account/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/account/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated account")


@mcp.tool()
async def unifi_delete_account(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a account.

    Args:
        id: The _id of the account to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_account", "id": id},
            "DRY RUN (DELETE rest/account/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/account/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted account")


# --- Alarm (read-only) ---

@mcp.tool()
async def unifi_list_alarms(site: str = "") -> str:
    """List all alarms.

    Returns alarms from the UniFi controller.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/alarm", site=site or None)
    return _format_response(data, f"Found {len(data)} alarms")


# --- Dynamic_dns CRUD ---

@mcp.tool()
async def unifi_list_dynamic_dns_entries(site: str = "") -> str:
    """List all dynamic_dns_entries.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/dynamicdns", site=site or None)
    return _format_response(data, f"Found {len(data)} dynamic_dns_entries")


@mcp.tool()
async def unifi_get_dynamic_dns(id: str, site: str = "") -> str:
    """Get a single dynamic_dns by ID.

    Args:
        id: The _id of the dynamic_dns.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/dynamicdns/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_dynamic_dns(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new dynamic_dns.

    Args:
        data: Dynamic_dns configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_dynamic_dns", "data": data},
            "DRY RUN (POST rest/dynamicdns): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/dynamicdns", json_data=data, site=site or None)
    return _format_response(result, "Created dynamic_dns")


@mcp.tool()
async def unifi_update_dynamic_dns(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing dynamic_dns.

    Args:
        id: The _id of the dynamic_dns to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_dynamic_dns", "id": id, "data": data},
            "DRY RUN (PUT rest/dynamicdns/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/dynamicdns/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated dynamic_dns")


@mcp.tool()
async def unifi_delete_dynamic_dns(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a dynamic_dns.

    Args:
        id: The _id of the dynamic_dns to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_dynamic_dns", "id": id},
            "DRY RUN (DELETE rest/dynamicdns/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/dynamicdns/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted dynamic_dns")


# --- Event (read-only) ---

@mcp.tool()
async def unifi_list_events(site: str = "") -> str:
    """List all events.

    Returns events from the UniFi controller.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/event", site=site or None)
    return _format_response(data, f"Found {len(data)} events")


# --- Firewall_group CRUD ---

@mcp.tool()
async def unifi_list_firewall_groups(site: str = "") -> str:
    """List all firewall_groups.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/firewallgroup", site=site or None)
    return _format_response(data, f"Found {len(data)} firewall_groups")


@mcp.tool()
async def unifi_get_firewall_group(id: str, site: str = "") -> str:
    """Get a single firewall_group by ID.

    Args:
        id: The _id of the firewall_group.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/firewallgroup/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_firewall_group(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new firewall_group.

    Args:
        data: Firewall_group configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Reference this group's _id in src_firewallgroup_ids or dst_firewallgroup_ids when creating firewall rules.
    """
    if not confirm:
        return _format_response(
            {"action": "create_firewall_group", "data": data},
            "DRY RUN (POST rest/firewallgroup): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/firewallgroup", json_data=data, site=site or None)
    return _format_response(result, "Created firewall_group")


@mcp.tool()
async def unifi_update_firewall_group(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing firewall_group.

    Args:
        id: The _id of the firewall_group to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Reference this group's _id in src_firewallgroup_ids or dst_firewallgroup_ids when creating firewall rules.
    """
    if not confirm:
        return _format_response(
            {"action": "update_firewall_group", "id": id, "data": data},
            "DRY RUN (PUT rest/firewallgroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/firewallgroup/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated firewall_group")


@mcp.tool()
async def unifi_delete_firewall_group(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a firewall_group.

    Args:
        id: The _id of the firewall_group to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_firewall_group", "id": id},
            "DRY RUN (DELETE rest/firewallgroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/firewallgroup/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted firewall_group")


# --- Firewall_rule CRUD ---

@mcp.tool()
async def unifi_list_firewall_rules(site: str = "") -> str:
    """List all firewall_rules.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/firewallrule", site=site or None)
    return _format_response(data, f"Found {len(data)} firewall_rules")


@mcp.tool()
async def unifi_get_firewall_rule(id: str, site: str = "") -> str:
    """Get a single firewall_rule by ID.

    Args:
        id: The _id of the firewall_rule.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/firewallrule/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_firewall_rule(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new firewall_rule.

    Args:
        data: Firewall_rule configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Create firewall groups first (unifi_create_firewall_group) to use in src/dst_firewallgroup_ids.
    """
    if not confirm:
        return _format_response(
            {"action": "create_firewall_rule", "data": data},
            "DRY RUN (POST rest/firewallrule): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/firewallrule", json_data=data, site=site or None)
    return _format_response(result, "Created firewall_rule")


@mcp.tool()
async def unifi_update_firewall_rule(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing firewall_rule.

    Args:
        id: The _id of the firewall_rule to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Create firewall groups first (unifi_create_firewall_group) to use in src/dst_firewallgroup_ids.
    """
    if not confirm:
        return _format_response(
            {"action": "update_firewall_rule", "id": id, "data": data},
            "DRY RUN (PUT rest/firewallrule/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/firewallrule/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated firewall_rule")


@mcp.tool()
async def unifi_delete_firewall_rule(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a firewall_rule.

    Args:
        id: The _id of the firewall_rule to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_firewall_rule", "id": id},
            "DRY RUN (DELETE rest/firewallrule/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/firewallrule/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted firewall_rule")


# --- Network CRUD ---

@mcp.tool()
async def unifi_list_networks(site: str = "") -> str:
    """List all networks.

    Key fields: ipv6_interface_type (str: "none"), ipv6_ra_priority (str: "high"), ipv6_setting_preference (str: "auto"), networkgroup (str: "LAN"), purpose (str: "corporate"|"vlan-only"), setting_preference (str: "manual"), external_id (str), is_nat (bool)
    """
    client = await _get_client()
    data = await client.request("GET", "rest/networkconf", site=site or None)
    return _format_response(data, f"Found {len(data)} networks")


@mcp.tool()
async def unifi_get_network(id: str, site: str = "") -> str:
    """Get a single network by ID.

    Args:
        id: The _id of the network.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/networkconf/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_network(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new network.

    Args:
        data: Network configuration.
            Fields: ipv6_interface_type (str: "none"), ipv6_ra_priority (str: "high"), ipv6_setting_preference (str: "auto"), networkgroup (str: "LAN"), purpose (str: "corporate"|"vlan-only"), setting_preference (str: "manual"), external_id (str), is_nat (bool), name (str), vlan_enabled (bool)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Use this network's _id as native_networkconf_id in port profiles or networkconf_id in WLANs.
    """
    if not confirm:
        return _format_response(
            {"action": "create_network", "data": data},
            "DRY RUN (POST rest/networkconf): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/networkconf", json_data=data, site=site or None)
    return _format_response(result, "Created network")


@mcp.tool()
async def unifi_update_network(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing network.

    Args:
        id: The _id of the network to update.
        data: Fields to update.
            Fields: ipv6_interface_type (str: "none"), ipv6_ra_priority (str: "high"), ipv6_setting_preference (str: "auto"), networkgroup (str: "LAN"), purpose (str: "corporate"|"vlan-only"), setting_preference (str: "manual"), external_id (str), is_nat (bool), name (str), vlan_enabled (bool)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Use this network's _id as native_networkconf_id in port profiles or networkconf_id in WLANs.
    """
    if not confirm:
        return _format_response(
            {"action": "update_network", "id": id, "data": data},
            "DRY RUN (PUT rest/networkconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/networkconf/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated network")


@mcp.tool()
async def unifi_delete_network(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a network.

    Args:
        id: The _id of the network to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_network", "id": id},
            "DRY RUN (DELETE rest/networkconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/networkconf/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted network")


# --- Port_profile CRUD ---

@mcp.tool()
async def unifi_list_port_profiles(site: str = "") -> str:
    """List all port_profiles.

    Key fields: dot1x_ctrl (str: "force_authorized"), forward (str: "customize"), native_networkconf_id (str, see unifi_list_networks), op_mode (str: "switch"), poe_mode (str: "auto"), setting_preference (str: "auto"), tagged_vlan_mgmt (str: "auto"), voice_networkconf_id (str, see unifi_list_networks)
    """
    client = await _get_client()
    data = await client.request("GET", "rest/portconf", site=site or None)
    return _format_response(data, f"Found {len(data)} port_profiles")


@mcp.tool()
async def unifi_get_port_profile(id: str, site: str = "") -> str:
    """Get a single port_profile by ID.

    Args:
        id: The _id of the port_profile.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/portconf/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_port_profile(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new port_profile.

    Args:
        data: Port_profile configuration.
            Fields: dot1x_ctrl (str: "force_authorized"), forward (str: "customize"), native_networkconf_id (str, see unifi_list_networks), op_mode (str: "switch"), poe_mode (str: "auto"), setting_preference (str: "auto"), tagged_vlan_mgmt (str: "auto"), voice_networkconf_id (str, see unifi_list_networks), autoneg (bool), dot1x_idle_timeout (int)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Apply this profile to switch ports via unifi_set_port_override with portconf_id.
    """
    if not confirm:
        return _format_response(
            {"action": "create_port_profile", "data": data},
            "DRY RUN (POST rest/portconf): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/portconf", json_data=data, site=site or None)
    return _format_response(result, "Created port_profile")


@mcp.tool()
async def unifi_update_port_profile(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing port_profile.

    Args:
        id: The _id of the port_profile to update.
        data: Fields to update.
            Fields: dot1x_ctrl (str: "force_authorized"), forward (str: "customize"), native_networkconf_id (str, see unifi_list_networks), op_mode (str: "switch"), poe_mode (str: "auto"), setting_preference (str: "auto"), tagged_vlan_mgmt (str: "auto"), voice_networkconf_id (str, see unifi_list_networks), autoneg (bool), dot1x_idle_timeout (int)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Apply this profile to switch ports via unifi_set_port_override with portconf_id.
    """
    if not confirm:
        return _format_response(
            {"action": "update_port_profile", "id": id, "data": data},
            "DRY RUN (PUT rest/portconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/portconf/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated port_profile")


@mcp.tool()
async def unifi_delete_port_profile(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a port_profile.

    Args:
        id: The _id of the port_profile to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_port_profile", "id": id},
            "DRY RUN (DELETE rest/portconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/portconf/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted port_profile")


# --- Port_forward CRUD ---

@mcp.tool()
async def unifi_list_port_forwards(site: str = "") -> str:
    """List all port_forwards.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/portforward", site=site or None)
    return _format_response(data, f"Found {len(data)} port_forwards")


@mcp.tool()
async def unifi_get_port_forward(id: str, site: str = "") -> str:
    """Get a single port_forward by ID.

    Args:
        id: The _id of the port_forward.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/portforward/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_port_forward(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new port_forward.

    Args:
        data: Port_forward configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Ensure the destination IP (fwd) is a static address or DHCP reservation on your network.
    """
    if not confirm:
        return _format_response(
            {"action": "create_port_forward", "data": data},
            "DRY RUN (POST rest/portforward): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/portforward", json_data=data, site=site or None)
    return _format_response(result, "Created port_forward")


@mcp.tool()
async def unifi_update_port_forward(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing port_forward.

    Args:
        id: The _id of the port_forward to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Ensure the destination IP (fwd) is a static address or DHCP reservation on your network.
    """
    if not confirm:
        return _format_response(
            {"action": "update_port_forward", "id": id, "data": data},
            "DRY RUN (PUT rest/portforward/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/portforward/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated port_forward")


@mcp.tool()
async def unifi_delete_port_forward(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a port_forward.

    Args:
        id: The _id of the port_forward to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_port_forward", "id": id},
            "DRY RUN (DELETE rest/portforward/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/portforward/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted port_forward")


# --- Radius_profile CRUD ---

@mcp.tool()
async def unifi_list_radius_profiles(site: str = "") -> str:
    """List all radius_profiles.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/radiusprofile", site=site or None)
    return _format_response(data, f"Found {len(data)} radius_profiles")


@mcp.tool()
async def unifi_get_radius_profile(id: str, site: str = "") -> str:
    """Get a single radius_profile by ID.

    Args:
        id: The _id of the radius_profile.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/radiusprofile/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_radius_profile(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new radius_profile.

    Args:
        data: Radius_profile configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Reference this profile's _id as radiusprofile_id when configuring WLANs with 802.1X authentication.
    """
    if not confirm:
        return _format_response(
            {"action": "create_radius_profile", "data": data},
            "DRY RUN (POST rest/radiusprofile): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/radiusprofile", json_data=data, site=site or None)
    return _format_response(result, "Created radius_profile")


@mcp.tool()
async def unifi_update_radius_profile(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing radius_profile.

    Args:
        id: The _id of the radius_profile to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Reference this profile's _id as radiusprofile_id when configuring WLANs with 802.1X authentication.
    """
    if not confirm:
        return _format_response(
            {"action": "update_radius_profile", "id": id, "data": data},
            "DRY RUN (PUT rest/radiusprofile/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/radiusprofile/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated radius_profile")


@mcp.tool()
async def unifi_delete_radius_profile(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a radius_profile.

    Args:
        id: The _id of the radius_profile to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_radius_profile", "id": id},
            "DRY RUN (DELETE rest/radiusprofile/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/radiusprofile/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted radius_profile")


# --- Route CRUD ---

@mcp.tool()
async def unifi_list_routes(site: str = "") -> str:
    """List all routes.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/routing", site=site or None)
    return _format_response(data, f"Found {len(data)} routes")


@mcp.tool()
async def unifi_get_route(id: str, site: str = "") -> str:
    """Get a single route by ID.

    Args:
        id: The _id of the route.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/routing/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_route(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new route.

    Args:
        data: Route configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_route", "data": data},
            "DRY RUN (POST rest/routing): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/routing", json_data=data, site=site or None)
    return _format_response(result, "Created route")


@mcp.tool()
async def unifi_update_route(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing route.

    Args:
        id: The _id of the route to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_route", "id": id, "data": data},
            "DRY RUN (PUT rest/routing/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/routing/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated route")


@mcp.tool()
async def unifi_delete_route(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a route.

    Args:
        id: The _id of the route to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_route", "id": id},
            "DRY RUN (DELETE rest/routing/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/routing/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted route")


# --- Settings (special handling: keyed by 'key' field) ---

@mcp.tool()
async def unifi_list_settings(site: str = "") -> str:
    """List all site settings. Returns all setting categories."""
    client = await _get_client()
    data = await client.request("GET", "rest/setting", site=site or None)
    return _format_response(data, f"Found {len(data)} setting categories")


@mcp.tool()
async def unifi_get_setting(key: str, site: str = "") -> str:
    """Get a specific site setting by key (e.g. 'super_identity', 'snmp').

    Args:
        key: The setting key to retrieve.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/setting", site=site or None)
    for item in data:
        if isinstance(item, dict) and item.get("key") == key:
            return _format_response(item)
    return _format_response(None, f"Setting '{key}' not found")


@mcp.tool()
async def unifi_update_setting(
    key: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update a site setting by key.

    Args:
        key: The setting key to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_setting", "key": key, "data": data},
            "DRY RUN (PUT rest/setting/{id}): Set confirm=True to execute.",
        )
    # Find the setting's _id first
    client = await _get_client()
    all_settings = await client.request("GET", "rest/setting", site=site or None)
    setting_id = None
    for item in all_settings:
        if isinstance(item, dict) and item.get("key") == key:
            setting_id = item.get("_id")
            break
    if not setting_id:
        return _format_response(None, f"Setting '{key}' not found")
    result = await client.request("PUT", f"rest/setting/{setting_id}", json_data=data, site=site or None)
    return _format_response(result, f"Updated setting '{key}'")


# --- Tag CRUD ---

@mcp.tool()
async def unifi_list_tags(site: str = "") -> str:
    """List all tags.
    """
    client = await _get_client()
    data = await client.request("GET", "rest/tag", site=site or None)
    return _format_response(data, f"Found {len(data)} tags")


@mcp.tool()
async def unifi_get_tag(id: str, site: str = "") -> str:
    """Get a single tag by ID.

    Args:
        id: The _id of the tag.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/tag/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_tag(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new tag.

    Args:
        data: Tag configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_tag", "data": data},
            "DRY RUN (POST rest/tag): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/tag", json_data=data, site=site or None)
    return _format_response(result, "Created tag")


@mcp.tool()
async def unifi_update_tag(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing tag.

    Args:
        id: The _id of the tag to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_tag", "id": id, "data": data},
            "DRY RUN (PUT rest/tag/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/tag/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated tag")


@mcp.tool()
async def unifi_delete_tag(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a tag.

    Args:
        id: The _id of the tag to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_tag", "id": id},
            "DRY RUN (DELETE rest/tag/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/tag/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted tag")


# --- User CRUD ---

@mcp.tool()
async def unifi_list_users(site: str = "") -> str:
    """List all users.

    Key fields: last_connection_network_id (str, see unifi_list_networks), last_radio (str: "ng"), oui (str: "Example"), usergroup_id (str, see unifi_list_user_groups), disconnect_timestamp (int), first_seen (int), is_guest (bool), is_wired (bool)
    """
    client = await _get_client()
    data = await client.request("GET", "rest/user", site=site or None)
    return _format_response(data, f"Found {len(data)} users")


@mcp.tool()
async def unifi_get_user(id: str, site: str = "") -> str:
    """Get a single user by ID.

    Args:
        id: The _id of the user.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/user/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_user(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new user.

    Args:
        data: User configuration.
            Fields: last_connection_network_id (str, see unifi_list_networks), last_radio (str: "ng"), oui (str: "Example"), usergroup_id (str, see unifi_list_user_groups), disconnect_timestamp (int), first_seen (int), is_guest (bool), is_wired (bool), last_connection_network_name (str), last_ip (str)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_user", "data": data},
            "DRY RUN (POST rest/user): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/user", json_data=data, site=site or None)
    return _format_response(result, "Created user")


@mcp.tool()
async def unifi_update_user(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing user.

    Args:
        id: The _id of the user to update.
        data: Fields to update.
            Fields: last_connection_network_id (str, see unifi_list_networks), last_radio (str: "ng"), oui (str: "Example"), usergroup_id (str, see unifi_list_user_groups), disconnect_timestamp (int), first_seen (int), is_guest (bool), is_wired (bool), last_connection_network_name (str), last_ip (str)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_user", "id": id, "data": data},
            "DRY RUN (PUT rest/user/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/user/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated user")


@mcp.tool()
async def unifi_delete_user(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a user.

    Args:
        id: The _id of the user to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_user", "id": id},
            "DRY RUN (DELETE rest/user/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/user/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted user")


# --- User_group CRUD ---

@mcp.tool()
async def unifi_list_user_groups(site: str = "") -> str:
    """List all user_groups.

    Key fields: name (str), qos_rate_max_down (int), qos_rate_max_up (int)
    """
    client = await _get_client()
    data = await client.request("GET", "rest/usergroup", site=site or None)
    return _format_response(data, f"Found {len(data)} user_groups")


@mcp.tool()
async def unifi_get_user_group(id: str, site: str = "") -> str:
    """Get a single user_group by ID.

    Args:
        id: The _id of the user_group.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/usergroup/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_user_group(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new user_group.

    Args:
        data: User_group configuration.
            Fields: name (str), qos_rate_max_down (int), qos_rate_max_up (int)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Assign users to this group by setting usergroup_id when creating or updating users.
    """
    if not confirm:
        return _format_response(
            {"action": "create_user_group", "data": data},
            "DRY RUN (POST rest/usergroup): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/usergroup", json_data=data, site=site or None)
    return _format_response(result, "Created user_group")


@mcp.tool()
async def unifi_update_user_group(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing user_group.

    Args:
        id: The _id of the user_group to update.
        data: Fields to update.
            Fields: name (str), qos_rate_max_down (int), qos_rate_max_up (int)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Assign users to this group by setting usergroup_id when creating or updating users.
    """
    if not confirm:
        return _format_response(
            {"action": "update_user_group", "id": id, "data": data},
            "DRY RUN (PUT rest/usergroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/usergroup/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated user_group")


@mcp.tool()
async def unifi_delete_user_group(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a user_group.

    Args:
        id: The _id of the user_group to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_user_group", "id": id},
            "DRY RUN (DELETE rest/usergroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/usergroup/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted user_group")


# --- Wlan CRUD ---

@mcp.tool()
async def unifi_list_wlans(site: str = "") -> str:
    """List all wlans.

    Key fields: ap_group_ids (list, see unifi_list_wlan_groups), ap_group_mode (str: "all"), dtim_mode (str: "custom"|"default"), mac_filter_policy (str: "allow"), mdns_proxy_mode (str: "off"), minrate_setting_preference (str: "auto"|"manual"), networkconf_id (str, see unifi_list_networks), pmf_mode (str: "disabled")
    """
    client = await _get_client()
    data = await client.request("GET", "rest/wlanconf", site=site or None)
    return _format_response(data, f"Found {len(data)} wlans")


@mcp.tool()
async def unifi_get_wlan(id: str, site: str = "") -> str:
    """Get a single wlan by ID.

    Args:
        id: The _id of the wlan.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/wlanconf/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_wlan(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new wlan.

    Args:
        data: Wlan configuration.
            Fields: ap_group_ids (list, see unifi_list_wlan_groups), ap_group_mode (str: "all"), dtim_mode (str: "custom"|"default"), mac_filter_policy (str: "allow"), mdns_proxy_mode (str: "off"), minrate_setting_preference (str: "auto"|"manual"), networkconf_id (str, see unifi_list_networks), pmf_mode (str: "disabled"), radius_macacl_format (str: "none_lower"), security (str: "wpapsk")
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Requires a network (networkconf_id from unifi_list_networks) and at least one adopted AP.
    """
    if not confirm:
        return _format_response(
            {"action": "create_wlan", "data": data},
            "DRY RUN (POST rest/wlanconf): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/wlanconf", json_data=data, site=site or None)
    return _format_response(result, "Created wlan")


@mcp.tool()
async def unifi_update_wlan(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing wlan.

    Args:
        id: The _id of the wlan to update.
        data: Fields to update.
            Fields: ap_group_ids (list, see unifi_list_wlan_groups), ap_group_mode (str: "all"), dtim_mode (str: "custom"|"default"), mac_filter_policy (str: "allow"), mdns_proxy_mode (str: "off"), minrate_setting_preference (str: "auto"|"manual"), networkconf_id (str, see unifi_list_networks), pmf_mode (str: "disabled"), radius_macacl_format (str: "none_lower"), security (str: "wpapsk")
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).

    Tip: Requires a network (networkconf_id from unifi_list_networks) and at least one adopted AP.
    """
    if not confirm:
        return _format_response(
            {"action": "update_wlan", "id": id, "data": data},
            "DRY RUN (PUT rest/wlanconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/wlanconf/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated wlan")


@mcp.tool()
async def unifi_delete_wlan(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a wlan.

    Args:
        id: The _id of the wlan to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_wlan", "id": id},
            "DRY RUN (DELETE rest/wlanconf/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/wlanconf/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted wlan")


# --- Wlan_group CRUD ---

@mcp.tool()
async def unifi_list_wlan_groups(site: str = "") -> str:
    """List all wlan_groups.

    Key fields: name (str)
    """
    client = await _get_client()
    data = await client.request("GET", "rest/wlangroup", site=site or None)
    return _format_response(data, f"Found {len(data)} wlan_groups")


@mcp.tool()
async def unifi_get_wlan_group(id: str, site: str = "") -> str:
    """Get a single wlan_group by ID.

    Args:
        id: The _id of the wlan_group.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/wlangroup/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_wlan_group(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new wlan_group.

    Args:
        data: Wlan_group configuration.
            Fields: name (str)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_wlan_group", "data": data},
            "DRY RUN (POST rest/wlangroup): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("POST", "rest/wlangroup", json_data=data, site=site or None)
    return _format_response(result, "Created wlan_group")


@mcp.tool()
async def unifi_update_wlan_group(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing wlan_group.

    Args:
        id: The _id of the wlan_group to update.
        data: Fields to update.
            Fields: name (str)
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_wlan_group", "id": id, "data": data},
            "DRY RUN (PUT rest/wlangroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("PUT", "rest/wlangroup/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated wlan_group")


@mcp.tool()
async def unifi_delete_wlan_group(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a wlan_group.

    Args:
        id: The _id of the wlan_group to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_wlan_group", "id": id},
            "DRY RUN (DELETE rest/wlangroup/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "rest/wlangroup/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted wlan_group")


# ===========================================================================
# Stat Endpoint Tools
# ===========================================================================

@mcp.tool()
async def unifi_list_stat_alarms(site: str = "") -> str:
    """List stat_alarms statistics.

    Key fields: _id, ap, ap_displayName, ap_model, ap_name
    """
    client = await _get_client()
    data = await client.request("GET", "stat/alarm", site=site or None)
    return _format_response(data, f"Found {len(data)} stat_alarms records")


@mcp.tool()
async def unifi_list_authorizations(site: str = "") -> str:
    """List authorizations statistics.
    """
    client = await _get_client()
    data = await client.request("POST", "stat/authorization", json_data={}, site=site or None)
    return _format_response(data, f"Found {len(data)} authorizations records")


@mcp.tool()
async def unifi_list_country_codes(site: str = "") -> str:
    """List country_codes statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/ccode", site=site or None)
    return _format_response(data, f"Found {len(data)} country_codes records")


@mcp.tool()
async def unifi_list_current_channels(site: str = "") -> str:
    """List current_channels statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/current-channel", site=site or None)
    return _format_response(data, f"Found {len(data)} current_channels records")


@mcp.tool()
async def unifi_list_devices(site: str = "") -> str:
    """List devices statistics.

    Note: also POST with macs filter

    Key fields: _id, _uptime, adopt_ip, adopt_url, adoptable_when_upgraded
    """
    client = await _get_client()
    data = await client.request("GET", "stat/device", site=site or None)
    return _format_response(data, f"Found {len(data)} devices records")


@mcp.tool()
async def unifi_list_devices_basic(site: str = "") -> str:
    """List devices_basic statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/device-basic", site=site or None)
    return _format_response(data, f"Found {len(data)} devices_basic records")


@mcp.tool()
async def unifi_list_dynamic_dns_stats(site: str = "") -> str:
    """List dynamic_dns_stats statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/dynamicdns", site=site or None)
    return _format_response(data, f"Found {len(data)} dynamic_dns_stats records")


@mcp.tool()
async def unifi_list_stat_events(site: str = "") -> str:
    """List stat_events statistics.

    Key fields: _id, ap, ap_displayName, ap_model, ap_name
    """
    client = await _get_client()
    data = await client.request("GET", "stat/event", site=site or None)
    return _format_response(data, f"Found {len(data)} stat_events records")


@mcp.tool()
async def unifi_list_health(site: str = "") -> str:
    """List health statistics.

    Key fields: status, subsystem
    """
    client = await _get_client()
    data = await client.request("GET", "stat/health", site=site or None)
    return _format_response(data, f"Found {len(data)} health records")


@mcp.tool()
async def unifi_list_port_forward_stats(site: str = "") -> str:
    """List port_forward_stats statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/portforward", site=site or None)
    return _format_response(data, f"Found {len(data)} port_forward_stats records")


@mcp.tool()
async def unifi_list_report(
    interval: str = "hourly",
    report_type: str = "site",
    site: str = "",
) -> str:
    """Get statistical reports.

    Args:
        interval: Report interval: '5minutes', 'hourly', or 'daily'.
        report_type: Report type: 'site', 'user', 'ap'.
        site: Site name (default: from env).

    Note: intervals: 5minutes, hourly, daily
    """
    client = await _get_client()
    path = f"stat/report/{interval}.{report_type}"
    data = await client.request("POST", path, json_data={}, site=site or None)
    return _format_response(data, f"Found {len(data)} report records")


@mcp.tool()
async def unifi_list_rogue_aps(site: str = "") -> str:
    """List rogue_aps statistics.

    Key fields: age, ap_mac, band, bssid, bw
    """
    client = await _get_client()
    data = await client.request("GET", "stat/rogueap", site=site or None)
    return _format_response(data, f"Found {len(data)} rogue_aps records")


@mcp.tool()
async def unifi_list_routing_stats(site: str = "") -> str:
    """List routing_stats statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/routing", site=site or None)
    return _format_response(data, f"Found {len(data)} routing_stats records")


@mcp.tool()
async def unifi_list_sessions(site: str = "") -> str:
    """List sessions statistics.
    """
    client = await _get_client()
    data = await client.request("POST", "stat/session", json_data={}, site=site or None)
    return _format_response(data, f"Found {len(data)} sessions records")


@mcp.tool()
async def unifi_list_site_dpi(site: str = "") -> str:
    """List site_dpi statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/sitedpi", site=site or None)
    return _format_response(data, f"Found {len(data)} site_dpi records")


@mcp.tool()
async def unifi_list_clients(site: str = "") -> str:
    """List clients statistics.

    Key fields: _id, _is_guest_by_usw, _last_seen_by_usw, _uptime_by_usw, anomalies
    """
    client = await _get_client()
    data = await client.request("GET", "stat/sta", site=site or None)
    return _format_response(data, f"Found {len(data)} clients records")


@mcp.tool()
async def unifi_list_client_dpi(site: str = "") -> str:
    """List client_dpi statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/stadpi", site=site or None)
    return _format_response(data, f"Found {len(data)} client_dpi records")


@mcp.tool()
async def unifi_list_sysinfo(site: str = "") -> str:
    """List sysinfo statistics.
    """
    client = await _get_client()
    data = await client.request("GET", "stat/sysinfo", site=site or None)
    return _format_response(data, f"Found {len(data)} sysinfo records")


# ===========================================================================
# Command Tools
# ===========================================================================

@mcp.tool()
async def unifi_list_backups(
    site: str = "",
) -> str:
    """Execute 'list-backups' via backup.

        site: Site name override (default: from env).
    """
    payload: dict[str, Any] = {"cmd": "list-backups"}
    client = await _get_client()
    result = await client.request("POST", "cmd/backup", json_data=payload, site=site or None)
    return _format_response(result, "Executed list-backups")


@mcp.tool()
async def unifi_delete_backup(
    filename: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'delete-backup' via backup.

    Args:
        filename: filename parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "delete_backup", "cmd": "delete-backup"}
        preview["filename"] = filename
        return _format_response(
            preview,
            "DRY RUN (POST cmd/backup): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "delete-backup"}
    payload["filename"] = filename
    client = await _get_client()
    result = await client.request("POST", "cmd/backup", json_data=payload, site=site or None)
    return _format_response(result, "Executed delete-backup")


@mcp.tool()
async def unifi_adopt_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'adopt' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "adopt_device", "cmd": "adopt"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "adopt"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed adopt")


@mcp.tool()
async def unifi_restart_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'restart' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "restart_device", "cmd": "restart"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "restart"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed restart")


@mcp.tool()
async def unifi_force_provision_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'force-provision' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "force_provision_device", "cmd": "force-provision"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "force-provision"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed force-provision")


@mcp.tool()
async def unifi_power_cycle_port(
    mac: str,
    port_idx: int,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'power-cycle' via devmgr.

    Args:
        mac: mac parameter (str).
    Args:
        port_idx: port_idx parameter (int).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "power_cycle_port", "cmd": "power-cycle"}
        preview["mac"] = mac
        preview["port_idx"] = port_idx
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "power-cycle"}
    payload["mac"] = mac
    payload["port_idx"] = port_idx
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed power-cycle")


@mcp.tool()
async def unifi_run_speedtest(
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'speedtest' via devmgr.

        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "run_speedtest", "cmd": "speedtest"}
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "speedtest"}
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed speedtest")


@mcp.tool()
async def unifi_get_speedtest_status(
    site: str = "",
) -> str:
    """Execute 'speedtest-status' via devmgr.

        site: Site name override (default: from env).
    """
    payload: dict[str, Any] = {"cmd": "speedtest-status"}
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed speedtest-status")


@mcp.tool()
async def unifi_locate_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'set-locate' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "locate_device", "cmd": "set-locate"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "set-locate"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed set-locate")


@mcp.tool()
async def unifi_unlocate_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'unset-locate' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "unlocate_device", "cmd": "unset-locate"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "unset-locate"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed unset-locate")


@mcp.tool()
async def unifi_upgrade_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'upgrade' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "upgrade_device", "cmd": "upgrade"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "upgrade"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed upgrade")


@mcp.tool()
async def unifi_upgrade_device_external(
    mac: str,
    url: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'upgrade-external' via devmgr.

    Args:
        mac: mac parameter (str).
    Args:
        url: url parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "upgrade_device_external", "cmd": "upgrade-external"}
        preview["mac"] = mac
        preview["url"] = url
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "upgrade-external"}
    payload["mac"] = mac
    payload["url"] = url
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed upgrade-external")


@mcp.tool()
async def unifi_migrate_device(
    mac: str,
    inform_url: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'migrate' via devmgr.

    Args:
        mac: mac parameter (str).
    Args:
        inform_url: inform_url parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "migrate_device", "cmd": "migrate"}
        preview["mac"] = mac
        preview["inform_url"] = inform_url
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "migrate"}
    payload["mac"] = mac
    payload["inform_url"] = inform_url
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed migrate")


@mcp.tool()
async def unifi_cancel_migrate_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'cancel-migrate' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "cancel_migrate_device", "cmd": "cancel-migrate"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "cancel-migrate"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed cancel-migrate")


@mcp.tool()
async def unifi_spectrum_scan(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'spectrum-scan' via devmgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "spectrum_scan", "cmd": "spectrum-scan"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/devmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "spectrum-scan"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/devmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed spectrum-scan")


@mcp.tool()
async def unifi_archive_all_alarms(
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'archive-all-alarms' via evtmgr.

        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "archive_all_alarms", "cmd": "archive-all-alarms"}
        return _format_response(
            preview,
            "DRY RUN (POST cmd/evtmgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "archive-all-alarms"}
    client = await _get_client()
    result = await client.request("POST", "cmd/evtmgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed archive-all-alarms")


@mcp.tool()
async def unifi_add_site(
    desc: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'add-site' via sitemgr.

    Args:
        desc: desc parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "add_site", "cmd": "add-site"}
        preview["desc"] = desc
        return _format_response(
            preview,
            "DRY RUN (POST cmd/sitemgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "add-site"}
    payload["desc"] = desc
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed add-site")


@mcp.tool()
async def unifi_delete_site(
    target_site: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'delete-site' via sitemgr.

    Args:
        target_site: Target site for the command (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "delete_site", "cmd": "delete-site"}
        preview["site"] = target_site
        return _format_response(
            preview,
            "DRY RUN (POST cmd/sitemgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "delete-site"}
    payload["site"] = target_site
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed delete-site")


@mcp.tool()
async def unifi_update_site(
    desc: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'update-site' via sitemgr.

    Args:
        desc: desc parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "update_site", "cmd": "update-site"}
        preview["desc"] = desc
        return _format_response(
            preview,
            "DRY RUN (POST cmd/sitemgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "update-site"}
    payload["desc"] = desc
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed update-site")


@mcp.tool()
async def unifi_get_admins(
    site: str = "",
) -> str:
    """Execute 'get-admins' via sitemgr.

        site: Site name override (default: from env).
    """
    payload: dict[str, Any] = {"cmd": "get-admins"}
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed get-admins")


@mcp.tool()
async def unifi_move_device(
    mac: str,
    target_site: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'move-device' via sitemgr.

    Args:
        mac: mac parameter (str).
    Args:
        target_site: Target site for the command (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "move_device", "cmd": "move-device"}
        preview["mac"] = mac
        preview["site"] = target_site
        return _format_response(
            preview,
            "DRY RUN (POST cmd/sitemgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "move-device"}
    payload["mac"] = mac
    payload["site"] = target_site
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed move-device")


@mcp.tool()
async def unifi_delete_device(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'delete-device' via sitemgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "delete_device", "cmd": "delete-device"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/sitemgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "delete-device"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/sitemgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed delete-device")


@mcp.tool()
async def unifi_block_client(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'block-sta' via stamgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "block_client", "cmd": "block-sta"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "block-sta"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed block-sta")


@mcp.tool()
async def unifi_unblock_client(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'unblock-sta' via stamgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "unblock_client", "cmd": "unblock-sta"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "unblock-sta"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed unblock-sta")


@mcp.tool()
async def unifi_kick_client(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'kick-sta' via stamgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "kick_client", "cmd": "kick-sta"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "kick-sta"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed kick-sta")


@mcp.tool()
async def unifi_forget_client(
    macs: list,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'forget-sta' via stamgr.

    Args:
        macs: macs parameter (list).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "forget_client", "cmd": "forget-sta"}
        preview["macs"] = macs
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "forget-sta"}
    payload["macs"] = macs
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed forget-sta")


@mcp.tool()
async def unifi_unauthorize_guest(
    mac: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'unauthorize-guest' via stamgr.

    Args:
        mac: mac parameter (str).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "unauthorize_guest", "cmd": "unauthorize-guest"}
        preview["mac"] = mac
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "unauthorize-guest"}
    payload["mac"] = mac
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed unauthorize-guest")


@mcp.tool()
async def unifi_authorize_guest(
    mac: str,
    minutes: int,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'authorize-guest' via stamgr.

    Args:
        mac: mac parameter (str).
    Args:
        minutes: minutes parameter (int).
        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "authorize_guest", "cmd": "authorize-guest"}
        preview["mac"] = mac
        preview["minutes"] = minutes
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stamgr): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "authorize-guest"}
    payload["mac"] = mac
    payload["minutes"] = minutes
    client = await _get_client()
    result = await client.request("POST", "cmd/stamgr", json_data=payload, site=site or None)
    return _format_response(result, "Executed authorize-guest")


@mcp.tool()
async def unifi_clear_dpi(
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'clear-dpi' via stat.

        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "clear_dpi", "cmd": "clear-dpi"}
        return _format_response(
            preview,
            "DRY RUN (POST cmd/stat): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "clear-dpi"}
    client = await _get_client()
    result = await client.request("POST", "cmd/stat", json_data=payload, site=site or None)
    return _format_response(result, "Executed clear-dpi")


@mcp.tool()
async def unifi_create_backup(
    confirm: bool = False,
    site: str = "",
) -> str:
    """Execute 'backup' via system.

        confirm: Must be True to execute. Returns preview if False.
        site: Site name override (default: from env).
    """
    if not confirm:
        preview = {"action": "create_backup", "cmd": "backup"}
        return _format_response(
            preview,
            "DRY RUN (POST cmd/system): Set confirm=True to execute.",
        )
    payload: dict[str, Any] = {"cmd": "backup"}
    client = await _get_client()
    result = await client.request("POST", "cmd/system", json_data=payload, site=site or None)
    return _format_response(result, "Executed backup")


# ===========================================================================
# v2 Endpoint Tools
# ===========================================================================

# --- v2: Firewall_policy ---

@mcp.tool()
async def unifi_list_firewall_policies(site: str = "") -> str:
    """List all firewall_policies (v2 API).
    """
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    data = await client.request("GET", "/v2/api/site/{site}/firewall-policies".replace("{site}", effective_site))
    if isinstance(data, list):
        return _format_response(data, f"Found {len(data)} firewall_policies")
    return _format_response(data)


@mcp.tool()
async def unifi_create_firewall_policy(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new firewall_policy (v2 API).

    Args:
        data: Firewall_policy configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_firewall_policy", "data": data},
            "DRY RUN (POST /v2/api/site/{site}/firewall-policies): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("POST", "/v2/api/site/{site}/firewall-policies".replace("{site}", effective_site), json_data=data)
    return _format_response(result, "Created firewall_policy")


@mcp.tool()
async def unifi_update_firewall_policy(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update a firewall_policy (v2 API).

    Args:
        id: The ID of the firewall_policy to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_firewall_policy", "id": id, "data": data},
            "DRY RUN (PUT /v2/api/site/{site}/firewall-policies/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("PUT", "/v2/api/site/{site}/firewall-policies/{id}".replace("{site}", effective_site).format(id=id), json_data=data)
    return _format_response(result, "Updated firewall_policy")


@mcp.tool()
async def unifi_delete_firewall_policy(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a firewall_policy (v2 API).

    Args:
        id: The ID of the firewall_policy to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_firewall_policy", "id": id},
            "DRY RUN (DELETE /v2/api/site/{site}/firewall-policies/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("DELETE", "/v2/api/site/{site}/firewall-policies/{id}".replace("{site}", effective_site).format(id=id))
    return _format_response(result, "Deleted firewall_policy")


# --- v2: Traffic_rule ---

@mcp.tool()
async def unifi_list_traffic_rules(site: str = "") -> str:
    """List all traffic_rules (v2 API).
    """
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    data = await client.request("GET", "/v2/api/site/{site}/trafficrules".replace("{site}", effective_site))
    if isinstance(data, list):
        return _format_response(data, f"Found {len(data)} traffic_rules")
    return _format_response(data)


@mcp.tool()
async def unifi_create_traffic_rule(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new traffic_rule (v2 API).

    Args:
        data: Traffic_rule configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_traffic_rule", "data": data},
            "DRY RUN (POST /v2/api/site/{site}/trafficrules): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("POST", "/v2/api/site/{site}/trafficrules".replace("{site}", effective_site), json_data=data)
    return _format_response(result, "Created traffic_rule")


@mcp.tool()
async def unifi_update_traffic_rule(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update a traffic_rule (v2 API).

    Args:
        id: The ID of the traffic_rule to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_traffic_rule", "id": id, "data": data},
            "DRY RUN (PUT /v2/api/site/{site}/trafficrules/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("PUT", "/v2/api/site/{site}/trafficrules/{id}".replace("{site}", effective_site).format(id=id), json_data=data)
    return _format_response(result, "Updated traffic_rule")


@mcp.tool()
async def unifi_delete_traffic_rule(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a traffic_rule (v2 API).

    Args:
        id: The ID of the traffic_rule to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_traffic_rule", "id": id},
            "DRY RUN (DELETE /v2/api/site/{site}/trafficrules/{id}): Set confirm=True to execute.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("DELETE", "/v2/api/site/{site}/trafficrules/{id}".replace("{site}", effective_site).format(id=id))
    return _format_response(result, "Deleted traffic_rule")


# ===========================================================================
# Global Endpoint Tools
# ===========================================================================

@mcp.tool()
async def unifi_self() -> str:
    """Self.
    """
    client = await _get_client()
    data = await client.request("GET", "/api/self")
    return _format_response(data)


@mcp.tool()
async def unifi_sites() -> str:
    """Sites.
    """
    client = await _get_client()
    data = await client.request("GET", "/api/self/sites")
    return _format_response(data)


@mcp.tool()
async def unifi_stat_admin() -> str:
    """Stat Admin.
    """
    client = await _get_client()
    data = await client.request("GET", "/api/stat/admin")
    return _format_response(data)


@mcp.tool()
async def unifi_stat_sites() -> str:
    """Stat Sites.
    """
    client = await _get_client()
    data = await client.request("GET", "/api/stat/sites")
    return _format_response(data)


@mcp.tool()
async def unifi_status() -> str:
    """Status.

    No authentication required.
    """
    # No auth required
    async with httpx.AsyncClient(
        base_url=f"https://{UNIFI_HOST}:{UNIFI_PORT}",
        verify=UNIFI_VERIFY_SSL,
        timeout=30.0,
    ) as c:
        resp = await c.request("GET", "/status")
        resp.raise_for_status()
        data = resp.json()
    return _format_response(data)


# ===========================================================================
# Special: Port Override Helper
# ===========================================================================

@mcp.tool()
async def unifi_set_port_override(
    device_id: str,
    port_idx: int,
    portconf_id: str = "",
    name: str = "",
    native_networkconf_id: str = "",
    forward: str = "",
    poe_mode: str = "",
    confirm: bool = False,
    site: str = "",
) -> str:
    """Set port override on a device (switch port configuration).

    This updates a specific port on a UniFi switch device.

    Args:
        device_id: The _id of the device.
        port_idx: Port number (1-based).
        portconf_id: Port profile ID to apply (from rest/portconf).
        name: Custom port name.
        native_networkconf_id: Network ID for native VLAN.
        forward: Forward mode ('all', 'customize', 'disabled').
        poe_mode: PoE mode ('auto', 'off', 'pasv24', 'passthrough').
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    override: dict[str, Any] = {"port_idx": port_idx}
    if portconf_id:
        override["portconf_id"] = portconf_id
    if name:
        override["name"] = name
    if native_networkconf_id:
        override["native_networkconf_id"] = native_networkconf_id
    if forward:
        override["forward"] = forward
    if poe_mode:
        override["poe_mode"] = poe_mode

    if not confirm:
        return _format_response(
            {"action": "set_port_override", "device_id": device_id, "override": override},
            "DRY RUN (PUT rest/device/{device_id}): Set confirm=True to execute.",
        )

    client = await _get_client()
    # First get current device to preserve existing overrides
    device_data = await client.request("GET", f"rest/device/{device_id}", site=site or None)
    if isinstance(device_data, list) and device_data:
        device_data = device_data[0]

    existing_overrides = []
    if isinstance(device_data, dict):
        existing_overrides = device_data.get("port_overrides", [])

    # Replace or append override for this port_idx
    new_overrides = [o for o in existing_overrides if o.get("port_idx") != port_idx]
    new_overrides.append(override)

    result = await client.request(
        "PUT",
        f"rest/device/{device_id}",
        json_data={"port_overrides": new_overrides},
        site=site or None,
    )
    return _format_response(result, f"Set port override on port {port_idx}")


# ---------------------------------------------------------------------------
# Entry point
# ---------------------------------------------------------------------------

if __name__ == "__main__":
    mcp.run()
