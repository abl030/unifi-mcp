"""Integration tests for REST firewall_rule endpoint (auto-generated).

DO NOT EDIT THIS FILE. All changes must be made in the generator.
"""

from __future__ import annotations

import time
import uuid

import httpx
import pytest


class TestFirewallruleCRUD:
    """Full CRUD lifecycle tests for firewall_rule."""

    def test_list_firewall_rules(self, authenticated_client):
        """Verify listing firewall_rules returns 200 + valid data."""
        data = authenticated_client.api_get("rest/firewallrule")
        assert isinstance(data, list)

    def test_crud_lifecycle(self, authenticated_client):
        """Create → Read → Update → Delete lifecycle test."""
        unique = uuid.uuid4().hex[:8]

        # --- Create ---
        create_data = {
            "name": f"test_fwrule_{unique}",
            "action": "drop",
            "ruleset": "WAN_IN",
            "protocol": "all",
            "rule_index": 4000,
            "protocol_match_excepted": False,
            "src_firewallgroup_ids": [],
            "src_mac_address": "",
            "src_address": "",
            "src_networkconf_id": "",
            "src_networkconf_type": "NETv4",
            "dst_firewallgroup_ids": [],
            "dst_address": "",
            "dst_networkconf_id": "",
            "dst_networkconf_type": "NETv4",
            "state_new": True,
            "state_established": True,
            "state_related": True,
            "state_invalid": False,
            "logging": False,
            "ipsec": "",
            "enabled": True,
        }
        try:
            result = authenticated_client.api_post("rest/firewallrule", create_data)
        except (httpx.HTTPStatusError, RuntimeError) as e:
            pytest.skip(f"Create firewall_rule not supported in test env: {e}")
        assert isinstance(result, list) and len(result) > 0
        created = result[0]
        resource_id = created["_id"]
        assert resource_id

        try:
            # --- Read back ---
            all_items = authenticated_client.api_get("rest/firewallrule")
            found = [i for i in all_items if i.get("_id") == resource_id]
            assert len(found) == 1, f"Created firewall_rule not found in list"

            # --- Update ---
            update_data = {"name": f"updated_fwrule_{unique}"}
            updated = authenticated_client.api_put(f"rest/firewallrule/{resource_id}", update_data)
            assert isinstance(updated, list)

        finally:
            # --- Delete (cleanup) ---
            authenticated_client.api_delete(f"rest/firewallrule/{resource_id}")

        # --- Verify gone ---
        time.sleep(0.5)
        all_items = authenticated_client.api_get("rest/firewallrule")
        found = [i for i in all_items if i.get("_id") == resource_id]
        assert len(found) == 0, "firewall_rule was not deleted"
