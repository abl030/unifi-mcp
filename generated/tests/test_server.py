"""Validation tests for the generated server.py (auto-generated).

These tests catch generator bugs — syntax errors, duplicate parameters,
duplicate function names — that would prevent the MCP server from loading.
They run without a UniFi controller.

DO NOT EDIT THIS FILE. All changes must be made in the generator.
"""

from __future__ import annotations

import ast
import subprocess
import sys
from pathlib import Path


SERVER_PATH = Path(__file__).parent.parent / "server.py"


class TestServerSyntax:
    """Verify generated/server.py is syntactically valid Python."""

    def test_server_compiles(self):
        """Compile server.py — catches SyntaxError including duplicate params."""
        source = SERVER_PATH.read_text()
        compile(source, str(SERVER_PATH), "exec")

    def test_no_duplicate_parameters(self):
        """Every function must have unique parameter names.

        ast.parse silently accepts duplicate params — only compile() or this
        explicit check catches them.  This test gives a better error message
        than compile() by naming the offending function.
        """
        source = SERVER_PATH.read_text()
        tree = ast.parse(source)

        errors: list[str] = []
        for node in ast.walk(tree):
            if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef)):
                params = [arg.arg for arg in node.args.args]
                seen: set[str] = set()
                for p in params:
                    if p in seen:
                        errors.append(
                            f"line {node.lineno}: {node.name}() has duplicate parameter '{p}'"
                        )
                    seen.add(p)

        assert not errors, (
            "Duplicate parameters found in generated server:\n"
            + "\n".join(errors)
        )

    def test_no_duplicate_function_names(self):
        """Every top-level function name must be unique."""
        source = SERVER_PATH.read_text()
        tree = ast.parse(source)

        names: dict[str, int] = {}
        for node in ast.iter_child_nodes(tree):
            if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef)):
                if node.name in names:
                    first_line = names[node.name]
                    assert False, (
                        f"Duplicate function '{node.name}' at lines {first_line} and {node.lineno}"
                    )
                names[node.name] = node.lineno

    def test_server_importable(self):
        """Verify server.py can be imported without error."""
        result = subprocess.run(
            [sys.executable, "-c", f"import ast; compile(open('{SERVER_PATH}').read(), '{SERVER_PATH}', 'exec')"],
            capture_output=True,
            text=True,
        )
        assert result.returncode == 0, f"Server import failed:\n{result.stderr}"

    def test_tool_count(self):
        """Verify the expected number of tool functions are generated."""
        source = SERVER_PATH.read_text()
        tree = ast.parse(source)

        tool_funcs = [
            node.name
            for node in ast.iter_child_nodes(tree)
            if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef))
            and node.name.startswith("unifi_")
        ]
        assert len(tool_funcs) == 285, (
            f"Expected 285 tool functions, found {len(tool_funcs)}: "
            f"missing or extra tools detected"
        )
