"""Integration tests for command endpoints (auto-generated).

Only safe, non-destructive commands are tested.

DO NOT EDIT THIS FILE. All changes must be made in the generator.
"""

from __future__ import annotations

import httpx
import pytest

{% for tool in cmd_tools %}
{% if tool.is_safe_test %}

class TestCmd{{ tool.tool_name | title | replace('_', '') }}:
    """Test the '{{ tool.command }}' command via {{ tool.manager }}."""

{% if tool.is_device_dependent %}
    def test_{{ tool.tool_name }}(self, authenticated_client):
        """Execute {{ tool.command }} — validates endpoint handles missing device correctly."""
        payload = {"cmd": "{{ tool.command }}"}
{% for pname, ptype in tool.params.items() %}
{% if ptype == "str" %}
        payload["{{ pname }}"] = "00:00:00:00:00:00"  # dummy MAC
{% elif ptype == "int" %}
        payload["{{ pname }}"] = 1
{% endif %}
{% endfor %}
        # Send request directly to inspect the response status
        resp = authenticated_client.client.post(
            f"/api/s/{authenticated_client.site}/{{ tool.path }}",
            json=payload,
            headers=authenticated_client._headers(),
        )
        # 200 = command accepted, 400 = unknown device (expected without hardware)
        assert resp.status_code in (200, 400), f"Unexpected status {resp.status_code}"
        if resp.status_code == 400:
            body = resp.json()
            assert body.get("meta", {}).get("rc") == "error"
{% else %}
    def test_{{ tool.tool_name }}(self, authenticated_client):
        """Execute {{ tool.command }} and verify response."""
        payload = {"cmd": "{{ tool.command }}"}
{% for pname, ptype in tool.params.items() %}
{% if ptype == "str" %}
        payload["{{ pname }}"] = "00:00:00:00:00:00"  # dummy MAC
{% elif ptype == "int" %}
        payload["{{ pname }}"] = 1
{% endif %}
{% endfor %}
        try:
            result = authenticated_client.api_post("{{ tool.path }}", payload)
            assert result is not None
        except (RuntimeError, httpx.HTTPStatusError) as e:
            # Commands may fail without real devices — that's expected
            pytest.skip(f"Command not available in test environment: {e}")
{% endif %}

{% endif %}
{% endfor %}
