"""UniFi Network Controller MCP Server (auto-generated).

Generated from controller version {{ controller_version }}.
Total tools: ~{{ tool_count }}

DO NOT EDIT THIS FILE. All changes must be made in the generator.
"""

from __future__ import annotations

import json
import os
from typing import Any

import httpx
from fastmcp import FastMCP

mcp = FastMCP("UniFi Network Controller")

# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------

UNIFI_HOST = os.environ.get("UNIFI_HOST", "localhost")
UNIFI_PORT = int(os.environ.get("UNIFI_PORT", "8443"))
UNIFI_USERNAME = os.environ.get("UNIFI_USERNAME", "admin")
UNIFI_PASSWORD = os.environ.get("UNIFI_PASSWORD", "")
UNIFI_SITE = os.environ.get("UNIFI_SITE", "default")
UNIFI_VERIFY_SSL = os.environ.get("UNIFI_VERIFY_SSL", "false").lower() == "true"


# ---------------------------------------------------------------------------
# HTTP Client
# ---------------------------------------------------------------------------


class UniFiClient:
    """Handles authentication, session cookies, and CSRF tokens."""

    def __init__(self) -> None:
        self._client = httpx.AsyncClient(
            base_url=f"https://{UNIFI_HOST}:{UNIFI_PORT}",
            verify=UNIFI_VERIFY_SSL,
            timeout=30.0,
        )
        self._csrf_token: str | None = None
        self._logged_in = False

    async def login(self) -> None:
        resp = await self._client.post(
            "/api/login",
            json={"username": UNIFI_USERNAME, "password": UNIFI_PASSWORD},
        )
        resp.raise_for_status()
        # Extract CSRF token from cookies or response
        self._csrf_token = resp.cookies.get("csrf_token") or resp.headers.get("x-csrf-token")
        self._logged_in = True

    async def logout(self) -> None:
        if self._logged_in:
            try:
                await self._client.post("/api/logout")
            except Exception:
                pass
            self._logged_in = False

    async def _ensure_logged_in(self) -> None:
        if not self._logged_in:
            await self.login()

    async def request(
        self,
        method: str,
        path: str,
        json_data: dict | None = None,
        site: str | None = None,
    ) -> dict | list:
        """Make an authenticated API request. Auto-relogins on 401."""
        await self._ensure_logged_in()

        # Replace {site} placeholder in path
        effective_site = site or UNIFI_SITE
        full_path = path.replace("{site}", effective_site)

        # Ensure path starts with /
        if not full_path.startswith("/"):
            full_path = f"/api/s/{effective_site}/{full_path}"

        headers = {}
        if self._csrf_token:
            headers["x-csrf-token"] = self._csrf_token

        resp = await self._client.request(
            method, full_path, json=json_data, headers=headers,
        )

        # Auto-relogin on 401
        if resp.status_code == 401:
            await self.login()
            if self._csrf_token:
                headers["x-csrf-token"] = self._csrf_token
            resp = await self._client.request(
                method, full_path, json=json_data, headers=headers,
            )

        resp.raise_for_status()
        data = resp.json()

        # v1 API envelope
        if isinstance(data, dict) and "meta" in data:
            if data["meta"].get("rc") != "ok":
                msg = data["meta"].get("msg", "Unknown error")
                raise RuntimeError(f"UniFi API error: {msg}")
            return data.get("data", [])

        return data

    async def close(self) -> None:
        await self.logout()
        await self._client.aclose()


# Singleton client
_client = UniFiClient()


async def _get_client() -> UniFiClient:
    return _client


# ---------------------------------------------------------------------------
# Helper: format response
# ---------------------------------------------------------------------------

def _format_response(data: Any, summary: str | None = None) -> str:
    """Format API response data for tool output."""
    if summary:
        return f"{summary}\n\n{json.dumps(data, indent=2, default=str)}"
    return json.dumps(data, indent=2, default=str)


# ===========================================================================
# REST Endpoint Tools
# ===========================================================================
{% for tool in rest_tools %}
{% if tool.is_setting %}

# --- Settings (special handling: keyed by 'key' field) ---

@mcp.tool()
async def unifi_list_settings(site: str = "") -> str:
    """List all site settings. Returns all setting categories."""
    client = await _get_client()
    data = await client.request("GET", "rest/setting", site=site or None)
    return _format_response(data, f"Found {len(data)} setting categories")


@mcp.tool()
async def unifi_get_setting(key: str, site: str = "") -> str:
    """Get a specific site setting by key (e.g. 'super_identity', 'snmp').

    Args:
        key: The setting key to retrieve.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "rest/setting", site=site or None)
    for item in data:
        if isinstance(item, dict) and item.get("key") == key:
            return _format_response(item)
    return _format_response(None, f"Setting '{key}' not found")


@mcp.tool()
async def unifi_update_setting(
    key: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update a site setting by key.

    Args:
        key: The setting key to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_setting", "key": key, "data": data},
            "DRY RUN: Set confirm=True to execute this update.",
        )
    # Find the setting's _id first
    client = await _get_client()
    all_settings = await client.request("GET", "rest/setting", site=site or None)
    setting_id = None
    for item in all_settings:
        if isinstance(item, dict) and item.get("key") == key:
            setting_id = item.get("_id")
            break
    if not setting_id:
        return _format_response(None, f"Setting '{key}' not found")
    result = await client.request("PUT", f"rest/setting/{setting_id}", json_data=data, site=site or None)
    return _format_response(result, f"Updated setting '{key}'")

{% elif tool.is_readonly %}

# --- {{ tool.singular | title }} (read-only) ---

@mcp.tool()
async def unifi_list_{{ tool.plural }}(site: str = "") -> str:
    """List all {{ tool.plural }}.

    Returns {{ tool.plural }} from the UniFi controller.
    """
    client = await _get_client()
    data = await client.request("GET", "{{ tool.path }}", site=site or None)
    return _format_response(data, f"Found {len(data)} {{ tool.plural }}")

{% elif tool.is_crud %}

# --- {{ tool.singular | title }} CRUD ---

@mcp.tool()
async def unifi_list_{{ tool.plural }}(site: str = "") -> str:
    """List all {{ tool.plural }}.
{% if tool.has_samples %}

    Key fields: {{ tool.writable_fields[:5] | map(attribute='name') | join(', ') }}
{% endif %}
    """
    client = await _get_client()
    data = await client.request("GET", "{{ tool.path }}", site=site or None)
    return _format_response(data, f"Found {len(data)} {{ tool.plural }}")


@mcp.tool()
async def unifi_get_{{ tool.singular }}(id: str, site: str = "") -> str:
    """Get a single {{ tool.singular }} by ID.

    Args:
        id: The _id of the {{ tool.singular }}.
        site: Site name (default: from env).
    """
    client = await _get_client()
    data = await client.request("GET", "{{ tool.path }}/{id}".format(id=id), site=site or None)
    if isinstance(data, list) and len(data) == 1:
        return _format_response(data[0])
    return _format_response(data)


@mcp.tool()
async def unifi_create_{{ tool.singular }}(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new {{ tool.singular }}.

    Args:
        data: {{ tool.singular | title }} configuration.
{% if tool.writable_fields %}
            Writable fields include: {{ tool.writable_fields[:8] | map(attribute='name') | join(', ') }}
{% endif %}
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_{{ tool.singular }}", "data": data},
            "DRY RUN: Set confirm=True to execute this create.",
        )
    client = await _get_client()
    result = await client.request("POST", "{{ tool.path }}", json_data=data, site=site or None)
    return _format_response(result, "Created {{ tool.singular }}")


@mcp.tool()
async def unifi_update_{{ tool.singular }}(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update an existing {{ tool.singular }}.

    Args:
        id: The _id of the {{ tool.singular }} to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_{{ tool.singular }}", "id": id, "data": data},
            "DRY RUN: Set confirm=True to execute this update.",
        )
    client = await _get_client()
    result = await client.request("PUT", "{{ tool.path }}/{id}".format(id=id), json_data=data, site=site or None)
    return _format_response(result, "Updated {{ tool.singular }}")


@mcp.tool()
async def unifi_delete_{{ tool.singular }}(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a {{ tool.singular }}.

    Args:
        id: The _id of the {{ tool.singular }} to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_{{ tool.singular }}", "id": id},
            "DRY RUN: Set confirm=True to execute this delete.",
        )
    client = await _get_client()
    result = await client.request("DELETE", "{{ tool.path }}/{id}".format(id=id), site=site or None)
    return _format_response(result, "Deleted {{ tool.singular }}")

{% endif %}
{% endfor %}

# ===========================================================================
# Stat Endpoint Tools
# ===========================================================================
{% for tool in stat_tools %}
{% if tool.resource == "report" %}

@mcp.tool()
async def unifi_list_report(
    interval: str = "hourly",
    report_type: str = "site",
    site: str = "",
) -> str:
    """Get statistical reports.

    Args:
        interval: Report interval: '5minutes', 'hourly', or 'daily'.
        report_type: Report type: 'site', 'user', 'ap'.
        site: Site name (default: from env).

    Note: {{ tool.note }}
    """
    client = await _get_client()
    path = f"stat/report/{interval}.{report_type}"
    data = await client.request("POST", path, json_data={}, site=site or None)
    return _format_response(data, f"Found {len(data)} report records")

{% else %}

@mcp.tool()
async def unifi_list_{{ tool.display_name }}(site: str = "") -> str:
    """List {{ tool.display_name }} statistics.
{% if tool.note %}

    Note: {{ tool.note }}
{% endif %}
{% if tool.sample_fields %}

    Key fields: {{ tool.sample_fields | join(', ') }}
{% endif %}
    """
    client = await _get_client()
{% if tool.method == "POST" %}
    data = await client.request("POST", "{{ tool.path }}", json_data={}, site=site or None)
{% else %}
    data = await client.request("GET", "{{ tool.path }}", site=site or None)
{% endif %}
    return _format_response(data, f"Found {len(data)} {{ tool.display_name }} records")

{% endif %}
{% endfor %}

# ===========================================================================
# Command Tools
# ===========================================================================
{% for tool in cmd_tools %}

@mcp.tool()
async def unifi_{{ tool.tool_name }}(
{% for pname, ptype in tool.params.items() %}
    {{ pname }}: {{ ptype }},
{% endfor %}
{% if tool.is_mutation %}
    confirm: bool = False,
{% endif %}
    site: str = "",
) -> str:
    """Execute '{{ tool.command }}' via {{ tool.manager }}.

{% for pname, ptype in tool.params.items() %}
    Args:
        {{ pname }}: {{ pname }} parameter ({{ ptype }}).
{% endfor %}
{% if tool.is_mutation %}
        confirm: Must be True to execute. Returns preview if False.
{% endif %}
        site: Site name (default: from env).
    """
{% if tool.is_mutation %}
    if not confirm:
        preview = {"action": "{{ tool.tool_name }}", "cmd": "{{ tool.command }}"}
{% for pname, ptype in tool.params.items() %}
        preview["{{ pname }}"] = {{ pname }}
{% endfor %}
        return _format_response(
            preview,
            "DRY RUN: Set confirm=True to execute this command.",
        )
{% endif %}
    payload: dict[str, Any] = {"cmd": "{{ tool.command }}"}
{% for pname, ptype in tool.params.items() %}
{% if ptype == "list" %}
    payload["{{ pname }}"] = {{ pname }}
{% else %}
    payload["{{ pname }}"] = {{ pname }}
{% endif %}
{% endfor %}
    client = await _get_client()
    result = await client.request("POST", "{{ tool.path }}", json_data=payload, site=site or None)
    return _format_response(result, "Executed {{ tool.command }}")

{% endfor %}

# ===========================================================================
# v2 Endpoint Tools
# ===========================================================================
{% for tool in v2_tools %}

# --- v2: {{ tool.singular | title }} ---
{% if "GET" in tool.methods %}

@mcp.tool()
async def unifi_list_{{ tool.plural }}(site: str = "") -> str:
    """List all {{ tool.plural }} (v2 API).
{% if tool.has_samples %}

    Key fields: {{ tool.writable_fields[:5] | map(attribute='name') | join(', ') }}
{% endif %}
    """
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    data = await client.request("GET", "/{{ tool.path }}".replace("{site}", effective_site))
    if isinstance(data, list):
        return _format_response(data, f"Found {len(data)} {{ tool.plural }}")
    return _format_response(data)

{% endif %}
{% if "POST" in tool.methods %}

@mcp.tool()
async def unifi_create_{{ tool.singular }}(
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Create a new {{ tool.singular }} (v2 API).

    Args:
        data: {{ tool.singular | title }} configuration.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "create_{{ tool.singular }}", "data": data},
            "DRY RUN: Set confirm=True to execute this create.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("POST", "/{{ tool.path }}".replace("{site}", effective_site), json_data=data)
    return _format_response(result, "Created {{ tool.singular }}")

{% endif %}
{% if "PUT" in tool.methods %}

@mcp.tool()
async def unifi_update_{{ tool.singular }}(
    id: str,
    data: dict,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Update a {{ tool.singular }} (v2 API).

    Args:
        id: The ID of the {{ tool.singular }} to update.
        data: Fields to update.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "update_{{ tool.singular }}", "id": id, "data": data},
            "DRY RUN: Set confirm=True to execute this update.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("PUT", "/{{ tool.path }}/{id}".replace("{site}", effective_site).format(id=id), json_data=data)
    return _format_response(result, "Updated {{ tool.singular }}")

{% endif %}
{% if "DELETE" in tool.methods %}

@mcp.tool()
async def unifi_delete_{{ tool.singular }}(
    id: str,
    confirm: bool = False,
    site: str = "",
) -> str:
    """Delete a {{ tool.singular }} (v2 API).

    Args:
        id: The ID of the {{ tool.singular }} to delete.
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    if not confirm:
        return _format_response(
            {"action": "delete_{{ tool.singular }}", "id": id},
            "DRY RUN: Set confirm=True to execute this delete.",
        )
    client = await _get_client()
    effective_site = site or UNIFI_SITE
    result = await client.request("DELETE", "/{{ tool.path }}/{id}".replace("{site}", effective_site).format(id=id))
    return _format_response(result, "Deleted {{ tool.singular }}")

{% endif %}
{% endfor %}

# ===========================================================================
# Global Endpoint Tools
# ===========================================================================
{% for tool in global_tools %}

@mcp.tool()
async def unifi_{{ tool.name }}({{ 'site: str = ""' if '{site}' in tool.path else '' }}) -> str:
    """{{ tool.name | replace('_', ' ') | title }}.
{% if not tool.auth %}

    No authentication required.
{% endif %}
    """
{% if tool.auth %}
    client = await _get_client()
    data = await client.request("{{ tool.method }}", "{{ tool.path }}")
{% else %}
    # No auth required
    async with httpx.AsyncClient(
        base_url=f"https://{UNIFI_HOST}:{UNIFI_PORT}",
        verify=UNIFI_VERIFY_SSL,
        timeout=30.0,
    ) as c:
        resp = await c.request("{{ tool.method }}", "{{ tool.path }}")
        resp.raise_for_status()
        data = resp.json()
{% endif %}
    return _format_response(data)

{% endfor %}

# ===========================================================================
# Special: Port Override Helper
# ===========================================================================

@mcp.tool()
async def unifi_set_port_override(
    device_id: str,
    port_idx: int,
    portconf_id: str = "",
    name: str = "",
    native_networkconf_id: str = "",
    forward: str = "",
    poe_mode: str = "",
    confirm: bool = False,
    site: str = "",
) -> str:
    """Set port override on a device (switch port configuration).

    This updates a specific port on a UniFi switch device.

    Args:
        device_id: The _id of the device.
        port_idx: Port number (1-based).
        portconf_id: Port profile ID to apply (from rest/portconf).
        name: Custom port name.
        native_networkconf_id: Network ID for native VLAN.
        forward: Forward mode ('all', 'customize', 'disabled').
        poe_mode: PoE mode ('auto', 'off', 'pasv24', 'passthrough').
        confirm: Must be True to execute. Returns preview if False.
        site: Site name (default: from env).
    """
    override: dict[str, Any] = {"port_idx": port_idx}
    if portconf_id:
        override["portconf_id"] = portconf_id
    if name:
        override["name"] = name
    if native_networkconf_id:
        override["native_networkconf_id"] = native_networkconf_id
    if forward:
        override["forward"] = forward
    if poe_mode:
        override["poe_mode"] = poe_mode

    if not confirm:
        return _format_response(
            {"action": "set_port_override", "device_id": device_id, "override": override},
            "DRY RUN: Set confirm=True to execute this port override.",
        )

    client = await _get_client()
    # First get current device to preserve existing overrides
    device_data = await client.request("GET", f"rest/device/{device_id}", site=site or None)
    if isinstance(device_data, list) and device_data:
        device_data = device_data[0]

    existing_overrides = []
    if isinstance(device_data, dict):
        existing_overrides = device_data.get("port_overrides", [])

    # Replace or append override for this port_idx
    new_overrides = [o for o in existing_overrides if o.get("port_idx") != port_idx]
    new_overrides.append(override)

    result = await client.request(
        "PUT",
        f"rest/device/{device_id}",
        json_data={"port_overrides": new_overrides},
        site=site or None,
    )
    return _format_response(result, f"Set port override on port {port_idx}")


# ---------------------------------------------------------------------------
# Entry point
# ---------------------------------------------------------------------------

if __name__ == "__main__":
    mcp.run()
